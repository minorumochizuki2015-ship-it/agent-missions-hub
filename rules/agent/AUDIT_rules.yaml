結論：既存の `AUDIT_rules.yaml` に対して、UIゲートの後ろに「Audit outcome summary」手順を追加し、最終 Status と Target Commit SHA を明示する以外は内容を変えずに統合した完全修正版です。

```yaml
version: "2.0"
product: "Trae"

agent_role: "Execute ML and repo-governance audit with deterministic, testable enforcement"

background: "Integrated spec for ML+repo governance; this revision ADDS a separate UI-Audit gate (accessibility, visual regression, responsiveness, interaction, performance) that blocks deploy on failure."

objectives:
  - id: "OBJ-1"
    text: "Audit and enforce ML pipeline quality, reproducibility, and safety."
  - id: "OBJ-2"
    text: "Audit and enforce repository rules: minimal diffs, approvals, secrets, EOL LF, atomic writes, and deployment gates."
  - id: "OBJ-3"
    text: "Audit and enforce UI preview quality budgets (a11y/visual/perf/responsiveness/interaction) on real browsers; block deploy on failure."

definitions:
  terms:
    - name: "SSOT"
      meaning: "Single source of truth document; conflicts defer to SSOT."
    - name: "minimal unified diff"
      meaning: "Smallest possible textual change expressed as unified diff; no full-file replace."
    - name: "atomic write"
      meaning: "Write via *.tmp → validate → *.bak → rename; verify hashes after rename."
    - name: "AUTO_DECIDE"
      meaning: "Automated approval mode with guardrails; can be on/shadow/off."
    - name: "PII"
      meaning: "Personally identifiable information; must be absent or masked."
    - name: "sha_out"
      meaning: "Hash of produced artifacts or outputs for reproducibility checks."
    - name: "Lock file"
      meaning: "JSON file recording ownership, TTL, and status to prevent concurrent changes."
    - name: "axe_severity"
      meaning: "Accessibility violation severity per axe-core: minor, moderate, serious, critical."
    - name: "CLS"
      meaning: "Cumulative Layout Shift metric per Web Vitals."
    - name: "visual_diff_pct"
      meaning: "Percent of pixels differing between baseline and candidate screenshots."

io:
  inputs:
    description: "Japanese Markdown with audit rules and repo policies; plus optional UI preview bundle and routes."
    format: "markdown + static preview (dist/) + json configs"
  outputs:
    description: "Executable English YAML spec, machine-verifiable reports, diffs, and UI audit HTML reports"
    format: "yaml + json + .patch + html"

procedures:

  - name: "Data audit"
    steps:
      - "Validate dataset schema and dtypes match declared schema."
      - "Check missing values and numerical ranges; reject on violation."
      - "Detect PII via regex/entropy; action=mask or drop per safety_compliance."
      - "Verify splits equal {train:0.8, valid:0.2, test:0.0} within ±0.5%."
      - "Record preprocessing steps with seed=42 and versions."

  - name: "Model training audit"
    steps:
      - "Set seeds for Python/NumPy/Framework=42; log framework and CUDA versions."
      - "Enable deterministic kernels; fail if nondeterministic ops stay active."
      - "Check GPU>=6GB VRAM when gpu_required=true; else skip with reason."
      - "Validate hyperparameters match spec and are logged."

  - name: "Evaluation audit"
    steps:
      - "Compute metrics on validation set with fixed seed and frozen preprocessors."
      - "Persist metrics with timestamps and dataset/model hashes."
      - "Enforce evaluation.thresholds.pass_if expression; stop on failure."

  - name: "Ethics and bias audit"
    steps:
      - "Run subgroup fairness checks (demographic parity, equalized odds)."
      - "Flag disparities > 0.10 absolute in accuracy or precision across protected groups."
      - "Record remediation action items and deadlines."

  - name: "Documentation audit"
    steps:
      - "Verify model_card.md exists and includes purpose, data, training, metrics, limits."
      - "Ensure logs include env (OS, CUDA, drivers), seeds, and library versions."
      - "Link artifacts to model card and commit hash."

  - name: "Deployment audit"
    steps:
      - "Verify trained_model hash equals deploy artifact hash."
      - "Confirm monitoring tracks drift and emits alerts; store config snapshot."
      - "Validate rollback plan is current and executable."

  - name: "Approvals gate"
    steps:
      - "Read approvals table; require status=approved for external writes, rules updates, configs, protected areas."
      - "Forbid self-approval; ensure ts_dec ≥ ts_req; evidence path present."
      - "Block production apply if status=pending/expired."

  - name: "Secrets scan"
    steps:
      - "Run secrets scanner; allow only placeholders {REDACTED, CHANGEME, jwt-ci, webhook-ci}."
      - "Fail if any real secrets detected; record finding and stop."

  - name: "Atomic write and EOL verify"
    steps:
      - "Apply minimal unified diff; forbid replace-all."
      - "Write via *.tmp → validate → *.bak → rename; post-verify EOL=LF and SHA256(in/out) match policy."

  - name: "Artifact README generation"
    steps:
      - "Create artifacts/<task_id>/README.md with reproduce steps and metrics."
      - "Store dependencies and exact commands for re-run."

  - name: "Canary healthcheck"
    steps:
      - "Read canary params from constraints.policy_parameters.canary with env override."
      - "Run e2e tests and HTTP 200 healthcheck with retry/backoff and max_wait."
      - "On 3 consecutive failures set AUTO_DECIDE=off and record incident."

  - name: "Lock acquire and release"
    steps:
      - "Create ORCH/STATE/LOCKS/<task_id>.lock with {owner, task_id, ts_acquired, ttl_sec, status}."
      - "Set status=active on acquire; expired on TTL; released on success."
      - "Stop auto decisions on contention or when FREEZE=on."

  - name: "Rollback dry-run"
    steps:
      - "Run rollback script in dry-run; verify sha256 of target release."
      - "If checks pass and approval exists, mark rollback path as ready."

  - name: "CI gate validation"
    steps:
      - "Require pytest=100% pass; compute coverage by component (unit, integration, e2e)."
      - "Assert coverage.* ≥ constraints.policy_parameters.coverage_min.*."
      - "Fail on EOL≠LF or secrets findings; forbid diffs that exceed lane limits (A=3 files/50 lines; B=preferred<=130 lines, max 200 lines/5 files, >200 requires lead approval + full human review, >=400 forbidden; C=logic-only, lines/files unlimited)."

  - name: "Path policy check (Windows absolute)"
    steps:
      - "Validate evidence paths are absolute Windows paths using backslashes; forbid relative or forward-slash paths."
      - "Reject if policy violated and log remediation."

  - name: "SafeOps log audit"
    steps:
      - "Verify paths.safeops_rule_bootstrap_log latest entry timestamp meets PLAN gate and SHA256 matches paths.safeops_rule_bootstrap_hash."
      - "Cross-check CMD.safeops.dangerous_commands entries against approvals and observed commands; require matching APPROVALS.md rows."
      - "Fail if SafeOps logs missing entries or hashes drift; log remediation to audit_dir."

  - name: "Self-test (fairness & coverage synthesis)"
    steps:
      - "Compute per-group AUC and TPR; derive auc_gap and tpr_gap."
      - "Set fairness_ok by thresholds; set coverage_ok from CI artifacts."
      - "Emit self-test report (json) and persist."

  # === UI-Audit extension (separate agent, gate-enforced) ===

  - name: "Preview build verification"
    steps:
      - "Locate preview_dir (artifacts/preview or configured absolute path)."
      - "Serve locally if needed; validate routes exist and return HTTP 200."
      - "Record build hash (sha_out) and bundle sizes."

  - name: "UI accessibility audit (axe-core)"
    steps:
      - "Run axe on each route × viewport; collect violations by severity."
      - "Fail if any serious or critical violations exist."
      - "Persist per-node evidence and selectors."

  - name: "UI visual regression audit"
    steps:
      - "Capture screenshots; compare to baseline using SSIM+pixel diff."
      - "Compute visual_diff_pct; fail if > constraints.policy_parameters.ui_budgets.visual_diff_pct."
      - "Store before/after/diff images."

  - name: "UI responsiveness & interaction audit"
    steps:
      - "Test breakpoints [390, 768, 1024, 1280]; assert no horizontal scroll and tap targets ≥44px."
      - "Execute scripted flows (clicks, form submit, dialogs, toasts); assert keyboard focusability."
      - "Record failures with DOM snapshots."

  - name: "UI performance audit"
    steps:
      - "Measure Web Vitals (LCP, TTI) per route × viewport."
      - "Fail if LCP > constraints.policy_parameters.ui_budgets.lcp_s or TTI > constraints.policy_parameters.ui_budgets.tti_s."
      - "Record CLS; fail if > constraints.policy_parameters.ui_budgets.cls_max."

  - name: "UI approvals gate"
    steps:
      - "Aggregate UI audit results; set gate = PASS if all budgets met."
      - "Block /deploy if gate=FAIL; require remediations and re-run."
      - "Publish HTML report and JSON summary to artifacts/ui_audit/."

  - name: "Audit outcome summary"
    steps:
      - "Compile overall audit summary covering ML, repo, and UI gates."
      - "Set final Status: Block / Proceed with fixes / Proceed based on findings and gate results."
      - "Record target commit SHA, branch name, and Status into the audit report and machine-readable summary (e.g., JSON)."
      - "List prioritized TODOs for Worker when fixes are required, and specify any required human review or approvals."
  - name: "Shadow audit verification"
    steps:
      - "Require observability/policy/shadow_audit/manifest.jsonl to exist when shadow audit is enabled."
      - "Recompute hash chain from manifest.jsonl and compare with manifest.sha256; if mismatch or missing file, set Status=Block."
      - "If signature exists: cosign verify-blob --key env(COSIGN_KEY_VERIFY) against manifest.jsonl and manifest.sig; on failure set Status=Block; if cosign or key missing, mark signature=skip."

  - name: "Response template enforcement"
    steps:
      - "All AUDIT responses MUST begin with a [State] block containing workspace path, git status -sb, HEAD (git log -1 --oneline), shadow audit verify_chain result, and tests run (or reason not run)."
      - "All AUDIT responses MUST end with a Self-check block (Yes/No) for: measured data only, tests recorded or reason, lane-specific diff constraints noted (A=3/50; B<=130 preferred, 200 max/5 files; >200 needs lead approval + human review; >=400 NG; C=logic-only unlimited), shadow-audit mention."
      - "State and Self-check MUST be based on fresh commands per response; prior logs or assumptions are insufficient."
      - "If verification passes, note 'shadow audit chain: OK' and 'signature: OK/skip' in the audit report."

constraints:
  language: "English only"
  determinism:
    seed: 42
    note: "Set all RNGs; enable deterministic kernels; avoid nondeterministic GPU ops."
  prohibitions:
    - "No ambiguous verbs without metrics."
    - "No hidden assumptions."
    - "No full-file replacements; minimal unified diff only."
    - "No CRLF in tracked text; LF only."
    - "No self-approval."
    - "No edits in protected areas without approval."
    - "No relative evidence paths; Windows absolute path required."
    - "No Figma design mutations (read-only only)."
  write_policy:
    atomic_flow: "*.tmp → validate → *.bak → rename"
    post_verify: ["EOL=LF","SHA256(in/out)"]
  eol:
    encoding: "UTF-8"
    newline: "LF"
  path_policy_windows:
    absolute_required: true
    separator: "\\"
    forbidden: ["relative paths",".","/"]

policy_parameters:
  fairness:
    auc_gap_max: 0.05
    tpr_gap_max: 0.05
  coverage_min:
    unit: 0.85
    integration: 0.75
    e2e: 0.70
  canary:
    success_required: 5
    retry_sec: 5
    max_wait_sec: 30
  ui_budgets:
    lcp_s: 2.5
    tti_s: 3.0
    cls_max: 0.10
    visual_diff_pct: 0.10
    axe_max_serious_plus: 0

ml_specific:
  task_types: ["training","inference","evaluation"]
  data_requirements:
    schema: "feature_id:int, feature_name:str, feature_type:str, label:int"
    splits: {train: 0.8, valid: 0.2, test: 0.0}
  artifacts_required:
    - "audit_report.json"
    - "model_card.md"
    - "diff_evidence.patch"

safety_compliance:
  pii:
    allowed: false
    action_if_detected: "mask|drop|abort"
  secrets:
    placeholders_allowed: ["REDACTED","CHANGEME","jwt-ci","webhook-ci"]
    action_if_detected: "abort_and_log"
  model_cards: "required"

ui_specific:
  inputs:
    figma_ref: "optional, read-only; do not mutate designs"
    mapping_json: "node → shadcn component with props"
    preview_dir: "artifacts/preview/ (or absolute Windows path)"
    routes: ["/", "/components", "/forms/basic"]
  allowlist_tools:
    qa: ["Playwright","axe-core","opencv"]
    design: ["Figma AI Bridge"]
  artifacts:
    report_html: "artifacts/ui_audit/report.html"
    summary_json: "artifacts/ui_audit/summary.json"
    screenshots_dir: "artifacts/ui_audit/screens/"
    traces_dir: "artifacts/ui_audit/traces/"

acceptance_criteria:
  must:
    - "All fields in this schema present."
    - "Steps are atomic and testable."
    - "Determinism and seed setting enforced."
    - "Metrics and pass thresholds defined with explicit comparators."
    - "Secrets, EOL, atomic write, approvals, and path policies enforced."
    - "SafeOps rule_bootstrap hash and dangerous command logs verified against approvals and command history."
    - "UI gate PASS required: axe serious+ = 0, visual_diff_pct ≤ ui_budgets.visual_diff_pct, LCP/TTI within budgets, CLS ≤ ui_budgets.cls_max."
  must_not:
    - "Placeholders like 'TBD' or '??'."
    - "Ambiguous terms without definitions."
    - "Relative or forward-slash evidence paths."

guardrails:
  filesystem:
    dangerous_patterns:
      - "Remove-Item"
      - "rm -rf"
      - "shutil\.rmtree"
    enforce:
      block_without_safeops: true
```
