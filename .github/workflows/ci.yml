name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: ["main", "develop", "release/**", "feature/**"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:
    inputs:
      verify_run:
        description: "Run UI Gate tests during verify"
        type: choice
        options: ["0","1"]
        default: "0"

jobs:
  decide-gates:
    name: Decide Auto Gates
    runs-on: ubuntu-latest
    outputs:
      AUTO_GATE_UI: ${{ steps.decider.outputs.AUTO_GATE_UI }}
      AUTO_GATE_SBOM: ${{ steps.decider.outputs.AUTO_GATE_SBOM }}
      AUTO_GATE_SECRET_SCAN: ${{ steps.decider.outputs.AUTO_GATE_SECRET_SCAN }}
      AUTO_GATE_BANDIT: ${{ steps.decider.outputs.AUTO_GATE_BANDIT }}
      AUTO_GATE_GITOPS_PLAN: ${{ steps.decider.outputs.AUTO_GATE_GITOPS_PLAN }}
      AUTO_GATE_GITOPS_APPROVALS: ${{ steps.decider.outputs.AUTO_GATE_GITOPS_APPROVALS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies (decider)
        run: pip install pyyaml
      - name: Collect PR labels
        if: github.event_name == 'pull_request'
        run: |
          echo "GITHUB_PR_LABELS=${{ join(github.event.pull_request.labels.*.name, ',') }}" >> $GITHUB_ENV
      - name: Decide Auto Gates
        id: decider
        run: |
          python scripts/auto_gate_decider.py --base "${{ github.base_ref }}" --head "${{ github.sha }}"
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_REF: ${{ github.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

  ui-gate:
    name: UI Gate (auto)
    runs-on: ubuntu-latest
    needs: decide-gates
    if: needs.decide-gates.outputs.AUTO_GATE_UI != 'skip'
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Skip placeholder
        run: echo "UI Gate実行は既存パイプラインに統合予定（auto_gate_decider で run 判定）"

  sbom:
    name: SBOM (auto)
    runs-on: ubuntu-latest
    needs: decide-gates
    if: needs.decide-gates.outputs.AUTO_GATE_SBOM != 'skip'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: SBOM placeholder
        run: echo "SBOM 実行は別スクリプトと連携予定（auto_gate_decider で run 判定）"

  secret-scan:
    name: Secret Scan (auto)
    runs-on: ubuntu-latest
    needs: decide-gates
    if: needs.decide-gates.outputs.AUTO_GATE_SECRET_SCAN != 'skip'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Secret scan placeholder
        run: echo "Secret scan 実行は別スクリプトと連携予定（auto_gate_decider で run 判定）"

  bandit:
    name: Bandit (auto)
    runs-on: ubuntu-latest
    needs: decide-gates
    if: needs.decide-gates.outputs.AUTO_GATE_BANDIT != 'skip'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Bandit placeholder
        run: echo "Bandit 実行は別スクリプトと連携予定（auto_gate_decider で run 判定）"

  gitops-plan:
    name: GitOps Plan Check (auto)
    runs-on: ubuntu-latest
    needs: decide-gates
    if: needs.decide-gates.outputs.AUTO_GATE_GITOPS_PLAN != 'skip'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: GitOps plan placeholder
        run: echo "plans/diff-plan.json チェックは別スクリプトと連携予定（auto_gate_decider で run 判定）"

  gitops-approvals:
    name: GitOps Approvals Check (auto)
    runs-on: ubuntu-latest
    needs: decide-gates
    if: needs.decide-gates.outputs.AUTO_GATE_GITOPS_APPROVALS != 'skip'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: GitOps approvals placeholder
        run: echo "APPROVALS/SafeOps/LOCK チェックは別スクリプトと連携予定（auto_gate_decider で run 判定）"

  ruff:
    name: Ruff Lint
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' && github.event_name != 'workflow_dispatch' }}
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-ruff-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-ruff-${{ runner.os }}-
            ci-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Run Ruff
        run: uv run ruff check --output-format=github src/mcp_agent_mail

  verify-ui-gate:
    name: Verify UI Gate Assets
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.verify_run == '1' }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            .npm-cache
          key: node-${{ runner.os }}-${{ hashFiles('package-lock.json', 'package.json') }}
          restore-keys: |
            node-${{ runner.os }}-
            node-
      - name: Setup Node (with cache)
        if: hashFiles('package-lock.json', 'npm-shrinkwrap.json', 'yarn.lock') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      - name: Setup Node (no cache)
        if: hashFiles('package-lock.json', 'npm-shrinkwrap.json', 'yarn.lock') == ''
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
      - name: Install Node dependencies
        run: |
          if [ ! -f package-lock.json ] && [ ! -f npm-shrinkwrap.json ] && [ ! -f yarn.lock ]; then
            echo "No Node lock file present. Skipping npm ci."
            exit 0
          fi
          npm ci
      - name: Install Playwright (Node)
        run: npx playwright install chromium
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-verify-ui-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-verify-ui-${{ runner.os }}-
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            ~/AppData/Local/ms-playwright
          key: pw-${{ runner.os }}-chromium-${{ env.PLAYWRIGHT_VERSION || 'latest' }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            pw-${{ runner.os }}-chromium-${{ env.PLAYWRIGHT_VERSION || 'latest' }}-
            pw-${{ runner.os }}-chromium-
            pw-${{ runner.os }}-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Install Playwright browsers (Python)
        run: uv run python -m playwright install chromium
      - name: Verify assets
        run: uv run python scripts/ops/verify_ui_gate_assets.py
      - name: Optional run UI Gate (VERIFY_RUN=1)
        env:
          VERIFY_RUN: ${{ inputs.verify_run }}
        run: uv run python scripts/ops/verify_ui_gate_assets.py
      - name: Append Phase 7 CI evidence (verify-ui-gate)
        if: ${{ always() && hashFiles('scripts/append_phase7_ci_evidence.py') != '' && (github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.verify_run == '1')) }}
        env:
          VERIFY_RUN: ${{ inputs.verify_run }}
        run: |
          curl -Ls https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
          uv run python scripts/append_phase7_ci_evidence.py --verify-run $VERIFY_RUN --no-pytest --label verify-ui-gate
      - name: Upload CI evidence JSONL (verify-ui-gate)
        if: ${{ always() && (github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.verify_run == '1')) }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-evidence-verify-ui-gate
          path: |
            observability/coverage/ci_phase7_evidence.jsonl
            reports/ci_evidence.jsonl
      - name: Upload UI audit artifacts
        if: ${{ hashFiles('artifacts/ui_audit/summary.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ui-audit
          path: artifacts/ui_audit

  ty:
    name: Ty Type Check
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' && (github.event_name != 'workflow_dispatch' || inputs.verify_run != '1') }}
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-ty-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-ty-${{ runner.os }}-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Run Ty
        run: uvx ty check

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.verify_run == '1') }}
    timeout-minutes: 15
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-test-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-test-${{ runner.os }}-${{ matrix.python-version }}-
            ci-test-${{ runner.os }}-
            ci-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Ensure junit directory
        run: mkdir -p observability/junit
      - name: Run minimal parallel test on PR or verify_run=1 dispatch
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.verify_run == '1') || github.event_name == 'pull_request' }}
        run: |
          uv run pytest tests/test_smoke_placeholder.py \
            --disable-warnings \
            --junitxml=observability/junit/junit.xml \
            --tb=short \
            -q
      - name: Run full test suite otherwise
        if: ${{ github.event_name != 'pull_request' && (github.event_name != 'workflow_dispatch' || inputs.verify_run != '1') }}
        run: |
          uv run pytest tests/ \
            --cov=mcp_agent_mail \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=observability/junit/junit.xml \
            --tb=short \
            -q
      - name: Upload junit report
        if: ${{ hashFiles('observability/junit/junit.xml') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.python-version }}
          path: observability/junit/junit.xml
      - name: Upload coverage reports
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.verify_run != '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
      - name: Upload shadow audit artifacts
        if: ${{ hashFiles('observability/policy/shadow_audit/manifest.jsonl') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: shadow-audit
          path: observability/policy/shadow_audit/**
      - name: Append Phase 7 CI evidence (test matrix)
        if: ${{ success() && inputs.verify_run == '1' && hashFiles('scripts/append_phase7_ci_evidence.py') != '' }}
        env:
          VERIFY_RUN: ${{ inputs.verify_run }}
        run: uv run python scripts/append_phase7_ci_evidence.py --verify-run $VERIFY_RUN --no-pytest --pytest-summary-from observability/junit/junit.xml --label "test-matrix:${{ matrix.python-version }}"
      - name: Upload CI evidence JSONL (test matrix)
        if: ${{ success() && inputs.verify_run == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-evidence-test-matrix-${{ matrix.python-version }}
          path: |
            observability/coverage/ci_phase7_evidence.jsonl
            reports/ci_evidence.jsonl
